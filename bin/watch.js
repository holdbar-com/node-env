#!/usr/bin/env node
import { readFile, rm, stat, writeFile } from 'node:fs/promises';
import { dirname, extname } from 'node:path';
import { watch } from './lib/compiler.js';
import { formatted } from './lib/formatter.js';
import { clearCache, lint } from './lib/linter.js';
import { install } from './lib/npm.js';
import { isDictionary, spelling } from './lib/spelling.js';
import { test } from './lib/tester.js';
const timestamps = await loadTimestamps();
let watcher;
let lastInput = [];
function start() {
    watcher = watch(async (success, inputFiles, outputFiles) => {
        // If we're in a 'package-lock'-loop, break it.
        if (inputFiles.length === 1 && inputFiles[0] === 'package-lock.json') {
            return;
        }
        if (inputFiles.includes('package.json') ||
            inputFiles.includes('package-lock.json')) {
            await installAndRestart();
            return;
        }
        if (isDictionary(inputFiles)) {
            if (await spelling(getSource(lastInput))) {
                console.log('🚀  All good 👌');
                timestamps.stages.spelling = new Date().toISOString();
                await saveTimestamps();
            }
            else {
                console.log('⚠️  Issues found 👆');
            }
            return;
        }
        await setOutputs(outputFiles);
        lastInput = inputFiles;
        await postCompile(success, inputFiles, outputFiles);
    });
}
async function installAndRestart() {
    watcher.close();
    await install();
    timestamps.stages = {};
    await clearCache();
    start();
}
async function shouldInstall() {
    const oldestStage = Object.values(timestamps.stages)
        .map((d) => new Date(d).getTime())
        .sort()
        .at(0) ?? -1;
    const latestPackage = (await Promise.all(['package.json', 'package-lock.json'].map((f) => stat(f))))
        .map((s) => s.ctimeMs)
        .sort()
        .at(-1) ?? 0;
    return oldestStage < latestPackage;
}
if (await shouldInstall()) {
    await install();
    timestamps.stages = {};
}
start();
function getSource(input) {
    return input.filter((f) => extname(f) === '.ts' &&
        !f.endsWith('.d.ts') &&
        !dirname(f).includes('node_modules'));
}
async function postCompile(success, inputFiles, outputFiles) {
    const source = getSource(inputFiles);
    const tests = outputFiles.filter((f) => dirname(f) === 'test' && !f.endsWith('.d.ts'));
    if ((await Promise.all([
        success,
        ifChanged('formatting', source, formatted),
        ifChanged('spelling', source, spelling),
        ifChanged('linting', source, lint),
        ifChanged('tests', source, (changed) => test(tests, changed)),
    ])).every((r) => r)) {
        console.log('🚀  All good 👌');
    }
    else {
        console.log('⚠️  Issues found 👆');
    }
    await saveTimestamps();
    console.log();
}
async function ifChanged(stage, source, fn) {
    const { stages } = timestamps;
    if (stages[stage]) {
        const lastSuccess = new Date(timestamps.stages[stage] ?? 0).getTime();
        const stats = await Promise.all(source.map(async (s) => {
            try {
                return await stat(s);
            }
            catch (e) {
                if (isFileNotFound(e)) {
                    return { mtimeMs: 0 };
                }
                throw e;
            }
        }));
        source = source
            .map((s, ix) => (stats[ix]?.mtimeMs ?? Number.MAX_VALUE) > lastSuccess ? s : '')
            .filter((s) => !!s);
    }
    if (await fn(source)) {
        stages[stage] = new Date().toISOString();
        return true;
    }
    return false;
}
async function setOutputs(outputs) {
    for (const old of timestamps.outputs) {
        if (!outputs.includes(old)) {
            try {
                await rm(old);
            }
            catch (e) {
                if (isFileNotFound(e)) {
                    continue;
                }
                throw e;
            }
        }
    }
    timestamps.outputs = outputs;
}
async function loadTimestamps() {
    try {
        return JSON.parse(await readFile('.timestamps.json', 'utf-8'));
    }
    catch (e) {
        if (isFileNotFound(e)) {
            return {
                outputs: [],
                stages: {},
            };
        }
        throw e;
    }
}
async function saveTimestamps() {
    await writeFile('.timestamps.json', JSON.stringify(timestamps, undefined, '    '));
}
function isFileNotFound(e) {
    return e.code === 'ENOENT';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2F0Y2guanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ3YXRjaC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzdDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUMxQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDL0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDM0QsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRXZDLE1BQU0sVUFBVSxHQUFHLE1BQU0sY0FBYyxFQUFFLENBQUM7QUFFMUMsSUFBSSxPQUE4QixDQUFDO0FBQ25DLElBQUksU0FBUyxHQUFhLEVBQUUsQ0FBQztBQUU3QixTQUFTLEtBQUs7SUFDWixPQUFPLEdBQUcsS0FBSyxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxFQUFFO1FBQ3pELCtDQUErQztRQUMvQyxJQUFJLFVBQVUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUMsS0FBSyxtQkFBbUIsRUFBRSxDQUFDO1lBQ3JFLE9BQU87UUFDVCxDQUFDO1FBQ0QsSUFDRSxVQUFVLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQztZQUNuQyxVQUFVLENBQUMsUUFBUSxDQUFDLG1CQUFtQixDQUFDLEVBQ3hDLENBQUM7WUFDRCxNQUFNLGlCQUFpQixFQUFF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QU8sQ0FBQyxFQUFFLENBQUM7Z0JBQ1gsSUFBSSxjQUFjLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztvQkFDdEIsU0FBUztnQkFDWCxDQUFDO2dCQUNELE1BQU0sQ0FBQyxDQUFDO1lBQ1YsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0lBQ0QsVUFBVSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7QUFDL0IsQ0FBQztBQUVELEtBQUssVUFBVSxjQUFjO0lBQzNCLElBQUksQ0FBQztRQUNILE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FDZixNQUFNLFFBQVEsQ0FBQyxrQkFBa0IsRUFBRSxPQUFPLENBQUMsQ0FDOUIsQ0FBQztJQUNsQixDQUFDO0lBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztRQUNYLElBQUksY0FBYyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDdEIsT0FBTztnQkFDTCxPQUFPLEVBQUUsRUFBRTtnQkFDWCxNQUFNLEVBQUUsRUFBRTthQUNYLENBQUM7UUFDSixDQUFDO1FBQ0QsTUFBTSxDQUFDLENBQUM7SUFDVixDQUFDO0FBQ0gsQ0FBQztBQUVELEtBQUssVUFBVSxjQUFjO0lBQzNCLE1BQU0sU0FBUyxDQUNiLGtCQUFrQixFQUNsQixJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQzlDLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxjQUFjLENBQUMsQ0FBVTtJQUNoQyxPQUFRLENBQXVCLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQztBQUNwRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiIyEvdXNyL2Jpbi9lbnYgbm9kZVxuXG5pbXBvcnQgeyByZWFkRmlsZSwgcm0sIHN0YXQsIHdyaXRlRmlsZSB9IGZyb20gJ25vZGU6ZnMvcHJvbWlzZXMnO1xuaW1wb3J0IHsgZGlybmFtZSwgZXh0bmFtZSB9IGZyb20gJ25vZGU6cGF0aCc7XG5pbXBvcnQgeyB3YXRjaCB9IGZyb20gJy4vbGliL2NvbXBpbGVyLmpzJztcbmltcG9ydCB7IGZvcm1hdHRlZCB9IGZyb20gJy4vbGliL2Zvcm1hdHRlci5qcyc7XG5pbXBvcnQgeyBjbGVhckNhY2hlLCBsaW50IH0gZnJvbSAnLi9saWIvbGludGVyLmpzJztcbmltcG9ydCB7IGluc3RhbGwgfSBmcm9tICcuL2xpYi9ucG0uanMnO1xuaW1wb3J0IHsgaXNEaWN0aW9uYXJ5LCBzcGVsbGluZyB9IGZyb20gJy4vbGliL3NwZWxsaW5nLmpzJztcbmltcG9ydCB7IHRlc3QgfSBmcm9tICcuL2xpYi90ZXN0ZXIuanMnO1xuXG5jb25zdCB0aW1lc3RhbXBzID0gYXdhaXQgbG9hZFRpbWVzdGFtcHMoKTtcblxubGV0IHdhdGNoZXI6IHsgY2xvc2U6ICgpID0+IHZvaWQgfTtcbmxldCBsYXN0SW5wdXQ6IHN0cmluZ1tdID0gW107XG5cbmZ1bmN0aW9uIHN0YXJ0KCkge1xuICB3YXRjaGVyID0gd2F0Y2goYXN5bmMgKHN1Y2Nlc3MsIGlucHV0RmlsZXMsIG91dHB1dEZpbGVzKSA9PiB7XG4gICAgLy8gSWYgd2UncmUgaW4gYSAncGFja2FnZS1sb2NrJy1sb29wLCBicmVhayBpdC5cbiAgICBpZiAoaW5wdXRGaWxlcy5sZW5ndGggPT09IDEgJiYgaW5wdXRGaWxlc1swXSA9PT0gJ3BhY2thZ2UtbG9jay5qc29uJykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoXG4gICAgICBpbnB1dEZpbGVzLmluY2x1ZGVzKCdwYWNrYWdlLmpzb24nKSB8fFxuICAgICAgaW5wdXRGaWxlcy5pbmNsdWRlcygncGFja2FnZS1sb2NrLmpzb24nKVxuICAgICkge1xuICAgICAgYXdhaXQgaW5zdGFsbEFuZFJlc3RhcnQoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGlzRGljdGlvbmFyeShpbnB1dEZpbGVzKSkge1xuICAgICAgaWYgKGF3YWl0IHNwZWxsaW5nKGdldFNvdXJjZShsYXN0SW5wdXQpKSkge1xuICAgICAgICBjb25zb2xlLmxvZygn8J+agCAgQWxsIGdvb2Qg8J+RjCcpO1xuICAgICAgICB0aW1lc3RhbXBzLnN0YWdlcy5zcGVsbGluZyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICAgICAgYXdhaXQgc2F2ZVRpbWVzdGFtcHMoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCfimqDvuI8gIElzc3VlcyBmb3VuZCDwn5GGJyk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGF3YWl0IHNldE91dHB1dHMob3V0cHV0RmlsZXMpO1xuICAgIGxhc3RJbnB1dCA9IGlucHV0RmlsZXM7XG4gICAgYXdhaXQgcG9zdENvbXBpbGUoc3VjY2VzcywgaW5wdXRGaWxlcywgb3V0cHV0RmlsZXMpO1xuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbEFuZFJlc3RhcnQoKSB7XG4gIHdhdGNoZXIuY2xvc2UoKTtcbiAgYXdhaXQgaW5zdGFsbCgpO1xuICB0aW1lc3RhbXBzLnN0YWdlcyA9IHt9O1xuICBhd2FpdCBjbGVhckNhY2hlKCk7XG4gIHN0YXJ0KCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNob3VsZEluc3RhbGwoKSB7XG4gIGNvbnN0IG9sZGVzdFN0YWdlID1cbiAgICBPYmplY3QudmFsdWVzKHRpbWVzdGFtcHMuc3RhZ2VzKVxuICAgICAgLm1hcCgoZCkgPT4gbmV3IERhdGUoZCkuZ2V0VGltZSgpKVxuICAgICAgLnNvcnQoKVxuICAgICAgLmF0KDApID8/IC0xO1xuICBjb25zdCBsYXRlc3RQYWNrYWdlID1cbiAgICAoXG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgWydwYWNrYWdlLmpzb24nLCAncGFja2FnZS1sb2NrLmpzb24nXS5tYXAoKGYpID0+IHN0YXQoZikpXG4gICAgICApXG4gICAgKVxuICAgICAgLm1hcCgocykgPT4gcy5jdGltZU1zKVxuICAgICAgLnNvcnQoKVxuICAgICAgLmF0KC0xKSA/PyAwO1xuICByZXR1cm4gb2xkZXN0U3RhZ2UgPCBsYXRlc3RQYWNrYWdlO1xufVxuXG5pZiAoYXdhaXQgc2hvdWxkSW5zdGFsbCgpKSB7XG4gIGF3YWl0IGluc3RhbGwoKTtcbiAgdGltZXN0YW1wcy5zdGFnZXMgPSB7fTtcbn1cbnN0YXJ0KCk7XG5cbmZ1bmN0aW9uIGdldFNvdXJjZShpbnB1dDogc3RyaW5nW10pIHtcbiAgcmV0dXJuIGlucHV0LmZpbHRlcihcbiAgICAoZikgPT5cbiAgICAgIGV4dG5hbWUoZikgPT09ICcudHMnICYmXG4gICAgICAhZi5lbmRzV2l0aCgnLmQudHMnKSAmJlxuICAgICAgIWRpcm5hbWUoZikuaW5jbHVkZXMoJ25vZGVfbW9kdWxlcycpXG4gICk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBvc3RDb21waWxlKFxuICBzdWNjZXNzOiBib29sZWFuLFxuICBpbnB1dEZpbGVzOiBzdHJpbmdbXSxcbiAgb3V0cHV0RmlsZXM6IHN0cmluZ1tdXG4pIHtcbiAgY29uc3Qgc291cmNlID0gZ2V0U291cmNlKGlucHV0RmlsZXMpO1xuICBjb25zdCB0ZXN0cyA9IG91dHB1dEZpbGVzLmZpbHRlcihcbiAgICAoZikgPT4gZGlybmFtZShmKSA9PT0gJ3Rlc3QnICYmICFmLmVuZHNXaXRoKCcuZC50cycpXG4gICk7XG4gIGlmIChcbiAgICAoXG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgIHN1Y2Nlc3MsXG4gICAgICAgIGlmQ2hhbmdlZCgnZm9ybWF0dGluZycsIHNvdXJjZSwgZm9ybWF0dGVkKSxcbiAgICAgICAgaWZDaGFuZ2VkKCdzcGVsbGluZycsIHNvdXJjZSwgc3BlbGxpbmcpLFxuICAgICAgICBpZkNoYW5nZWQoJ2xpbnRpbmcnLCBzb3VyY2UsIGxpbnQpLFxuICAgICAgICBpZkNoYW5nZWQoJ3Rlc3RzJywgc291cmNlLCAoY2hhbmdlZCkgPT4gdGVzdCh0ZXN0cywgY2hhbmdlZCkpLFxuICAgICAgXSlcbiAgICApLmV2ZXJ5KChyKSA9PiByKVxuICApIHtcbiAgICBjb25zb2xlLmxvZygn8J+agCAgQWxsIGdvb2Qg8J+RjCcpO1xuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUubG9nKCfimqDvuI8gIElzc3VlcyBmb3VuZCDwn5GGJyk7XG4gIH1cbiAgYXdhaXQgc2F2ZVRpbWVzdGFtcHMoKTtcbiAgY29uc29sZS5sb2coKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaWZDaGFuZ2VkKFxuICBzdGFnZTogc3RyaW5nLFxuICBzb3VyY2U6IHN0cmluZ1tdLFxuICBmbjogKHNyYzogc3RyaW5nW10pID0+IFByb21pc2U8Ym9vbGVhbj5cbikge1xuICBjb25zdCB7IHN0YWdlcyB9ID0gdGltZXN0YW1wcztcbiAgaWYgKHN0YWdlc1tzdGFnZV0pIHtcbiAgICBjb25zdCBsYXN0U3VjY2VzcyA9IG5ldyBEYXRlKHRpbWVzdGFtcHMuc3RhZ2VzW3N0YWdlXSA/PyAwKS5nZXRUaW1lKCk7XG4gICAgY29uc3Qgc3RhdHMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIHNvdXJjZS5tYXAoYXN5bmMgKHMpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICByZXR1cm4gYXdhaXQgc3RhdChzKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIGlmIChpc0ZpbGVOb3RGb3VuZChlKSkge1xuICAgICAgICAgICAgcmV0dXJuIHsgbXRpbWVNczogMCB9O1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG4gICAgc291cmNlID0gc291cmNlXG4gICAgICAubWFwKChzLCBpeCkgPT5cbiAgICAgICAgKHN0YXRzW2l4XT8ubXRpbWVNcyA/PyBOdW1iZXIuTUFYX1ZBTFVFKSA+IGxhc3RTdWNjZXNzID8gcyA6ICcnXG4gICAgICApXG4gICAgICAuZmlsdGVyKChzKSA9PiAhIXMpO1xuICB9XG4gIGlmIChhd2FpdCBmbihzb3VyY2UpKSB7XG4gICAgc3RhZ2VzW3N0YWdlXSA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbmludGVyZmFjZSBUaW1lc3RhbXBzIHtcbiAgb3V0cHV0czogc3RyaW5nW107XG4gIHN0YWdlczogeyBbc3RhZ2U6IHN0cmluZ106IHN0cmluZyB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRPdXRwdXRzKG91dHB1dHM6IHN0cmluZ1tdKSB7XG4gIGZvciAoY29uc3Qgb2xkIG9mIHRpbWVzdGFtcHMub3V0cHV0cykge1xuICAgIGlmICghb3V0cHV0cy5pbmNsdWRlcyhvbGQpKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBybShvbGQpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBpZiAoaXNGaWxlTm90Rm91bmQoZSkpIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICB0aW1lc3RhbXBzLm91dHB1dHMgPSBvdXRwdXRzO1xufVxuXG5hc3luYyBmdW5jdGlvbiBsb2FkVGltZXN0YW1wcygpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gSlNPTi5wYXJzZShcbiAgICAgIGF3YWl0IHJlYWRGaWxlKCcudGltZXN0YW1wcy5qc29uJywgJ3V0Zi04JylcbiAgICApIGFzIFRpbWVzdGFtcHM7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoaXNGaWxlTm90Rm91bmQoZSkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG91dHB1dHM6IFtdLFxuICAgICAgICBzdGFnZXM6IHt9LFxuICAgICAgfTtcbiAgICB9XG4gICAgdGhyb3cgZTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzYXZlVGltZXN0YW1wcygpIHtcbiAgYXdhaXQgd3JpdGVGaWxlKFxuICAgICcudGltZXN0YW1wcy5qc29uJyxcbiAgICBKU09OLnN0cmluZ2lmeSh0aW1lc3RhbXBzLCB1bmRlZmluZWQsICcgICAgJylcbiAgKTtcbn1cblxuZnVuY3Rpb24gaXNGaWxlTm90Rm91bmQoZTogdW5rbm93bikge1xuICByZXR1cm4gKGUgYXMgeyBjb2RlPzogc3RyaW5nIH0pLmNvZGUgPT09ICdFTk9FTlQnO1xufVxuIl19