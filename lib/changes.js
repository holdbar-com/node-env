import { readFile, rm, stat, writeFile } from 'node:fs/promises';
import { dirname, extname, join, resolve } from 'node:path';
import { formatted } from '../lib/formatter.js';
import { lint, makeCache } from '../lib/linter.js';
import { install } from '../lib/npm.js';
import { spelling } from '../lib/spelling.js';
import { test } from '../lib/tester.js';
export function getSource(input) {
    return input.filter((f) => extname(f) === '.ts' &&
        !f.endsWith('.d.ts') &&
        !dirname(f).includes('node_modules'));
}
export async function load(path) {
    return new Changes(path, await loadTimestamps(path));
}
export class Changes {
    #path;
    #timestamps;
    #lintCache;
    constructor(path, timestamps) {
        this.#path = path;
        this.#timestamps = timestamps;
        this.#lintCache = makeCache(path);
    }
    async preCompile(reporter, path) {
        if (await this.shouldInstall()) {
            await install(reporter, path);
            this.#timestamps.stages = {};
        }
    }
    async postCompile(reporter, path, inputFiles, compileResult) {
        const source = getSource(inputFiles);
        const result = (await Promise.all([
            compileResult,
            this.#ifChanged('formatting', source, (s) => formatted(reporter, path, s)),
            this.#ifChanged('spelling', source, (s) => spelling(reporter, path, s)),
            this.#ifChanged('linting', source, (s) => lint(reporter, path, s, this.#lintCache)),
            this.#ifChanged('tests', source, async (s) => {
                const outputFiles = await compileResult;
                if (!outputFiles) {
                    return false;
                }
                const tests = outputFiles.filter((f) => dirname(f) === 'test' && !f.endsWith('.d.ts'));
                return await test(reporter, path, tests, s);
            }),
        ])).every((r) => r);
        await this.#setOutputs(await compileResult);
        await this.#saveTimestamps();
        return result;
    }
    async shouldInstall() {
        const oldestStage = Object.values(this.#timestamps.stages)
            .map((d) => new Date(d).getTime())
            .sort()
            .at(0) ?? -1;
        const latestPackage = (await Promise.all(['package.json', 'package-lock.json'].map((f) => stat(resolve(this.#path, f)))))
            .map((s) => s.ctimeMs)
            .sort()
            .at(-1) ?? 0;
        return oldestStage < latestPackage;
    }
    async stageComplete(stage) {
        this.#timestamps.stages[stage] = new Date().toISOString();
        await this.#saveTimestamps();
    }
    async clearStages() {
        this.#timestamps.stages = {};
        this.#lintCache = makeCache(this.#path);
        await this.#saveTimestamps();
    }
    async #ifChanged(stage, source, fn) {
        const { stages } = this.#timestamps;
        if (stages[stage]) {
            const lastSuccess = new Date(this.#timestamps.stages[stage] ?? 0).getTime();
            const stats = await Promise.all(source.map(async (s) => {
                try {
                    return await stat(s);
                }
                catch (e) {
                    if (isFileNotFound(e)) {
                        return { mtimeMs: 0 };
                    }
                    throw e;
                }
            }));
            source = source
                .map((s, ix) => (stats[ix]?.mtimeMs ?? Number.MAX_VALUE) > lastSuccess ? s : '')
                .filter((s) => !!s);
        }
        if (await fn(source)) {
            stages[stage] = new Date().toISOString();
            return true;
        }
        return false;
    }
    async #setOutputs(outputs) {
        for (const old of this.#timestamps.outputs) {
            if (!outputs?.includes(old)) {
                try {
                    await rm(old);
                }
                catch (e) {
                    if (isFileNotFound(e)) {
                        continue;
                    }
                    throw e;
                }
            }
        }
        this.#timestamps.outputs = outputs ?? [];
    }
    async #saveTimestamps() {
        await writeFile(join(this.#path, '.timestamps.json'), JSON.stringify(this.#timestamps, undefined, '  '));
    }
}
async function loadTimestamps(path) {
    try {
        return JSON.parse(await readFile(join(path, '.timestamps.json'), 'utf-8'));
    }
    catch (e) {
        if (isFileNotFound(e)) {
            return {
                outputs: [],
                stages: {},
            };
        }
        throw e;
    }
}
function isFileNotFound(e) {
    return e.code === 'ENOENT';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbmdlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNoYW5nZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDNUQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDbkQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4QyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDOUMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBR3hDLE1BQU0sVUFBVSxTQUFTLENBQUMsS0FBZTtJQUN2QyxPQUFPLEtBQUssQ0FBQyxNQUFNLENBQ2pCLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FDSixPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssS0FBSztRQUNwQixDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDO1FBQ3BCLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FDdkMsQ0FBQztBQUNKLENBQUM7QUFFRCxNQUFNLENBQUMsS0FBSyxVQUFVLElBQUksQ0FBQyxJQUFZO0lBQ3JDLE9BQU8sSUFBSSxPQUFPLENBQUMsSUFBSSxFQUFFLE1BQU0sY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDdkQsQ0FBQztBQUVELE1BQU0sT0FBTyxPQUFPO0lBQ1QsS0FBSyxDQUFDO0lBQ04sV0FBVyxDQUFhO0lBQ2pDLFVBQVUsQ0FBQztJQUVYLFlBQVksSUFB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LGNBQWMsQ0FBQyxDQUFDLENBQUMsRUFBRTt3QkFDckIsU0FBUztxQkFDVjtvQkFDRCxNQUFNLENBQUMsQ0FBQztpQkFDVDthQUNGO1NBQ0Y7UUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sR0FBRyxPQUFPLElBQUksRUFBRSxDQUFDO0lBQzNDLENBQUM7SUFFRCxLQUFLLENBQUMsZUFBZTtRQUNuQixNQUFNLFNBQVMsQ0FDYixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxrQkFBa0IsQ0FBQyxFQUNwQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUNsRCxDQUFDO0lBQ0osQ0FBQztDQUNGO0FBT0QsS0FBSyxVQUFVLGNBQWMsQ0FBQyxJQUFZO0lBQ3hDLElBQUk7UUFDRixPQUFPLElBQUksQ0FBQyxLQUFLLENBQ2YsTUFBTSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxrQkFBa0IsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUMxQyxDQUFDO0tBQ2pCO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDVixJQUFJLGNBQWMsQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUNyQixPQUFPO2dCQUNMLE9BQU8sRUFBRSxFQUFFO2dCQUNYLE1BQU0sRUFBRSxFQUFFO2FBQ1gsQ0FBQztTQUNIO1FBQ0QsTUFBTSxDQUFDLENBQUM7S0FDVDtBQUNILENBQUM7QUFFRCxTQUFTLGNBQWMsQ0FBQyxDQUFVO0lBQ2hDLE9BQVEsQ0FBdUIsQ0FBQyxJQUFJLEtBQUssUUFBUSxDQUFDO0FBQ3BELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZWFkRmlsZSwgcm0sIHN0YXQsIHdyaXRlRmlsZSB9IGZyb20gJ25vZGU6ZnMvcHJvbWlzZXMnO1xuaW1wb3J0IHsgZGlybmFtZSwgZXh0bmFtZSwgam9pbiwgcmVzb2x2ZSB9IGZyb20gJ25vZGU6cGF0aCc7XG5pbXBvcnQgeyBmb3JtYXR0ZWQgfSBmcm9tICcuLi9saWIvZm9ybWF0dGVyLmpzJztcbmltcG9ydCB7IGxpbnQsIG1ha2VDYWNoZSB9IGZyb20gJy4uL2xpYi9saW50ZXIuanMnO1xuaW1wb3J0IHsgaW5zdGFsbCB9IGZyb20gJy4uL2xpYi9ucG0uanMnO1xuaW1wb3J0IHsgc3BlbGxpbmcgfSBmcm9tICcuLi9saWIvc3BlbGxpbmcuanMnO1xuaW1wb3J0IHsgdGVzdCB9IGZyb20gJy4uL2xpYi90ZXN0ZXIuanMnO1xuaW1wb3J0IHsgUmVwb3J0ZXIgfSBmcm9tICcuL3JlcG9ydGVyLmpzJztcblxuZXhwb3J0IGZ1bmN0aW9uIGdldFNvdXJjZShpbnB1dDogc3RyaW5nW10pIHtcbiAgcmV0dXJuIGlucHV0LmZpbHRlcihcbiAgICAoZikgPT5cbiAgICAgIGV4dG5hbWUoZikgPT09ICcudHMnICYmXG4gICAgICAhZi5lbmRzV2l0aCgnLmQudHMnKSAmJlxuICAgICAgIWRpcm5hbWUoZikuaW5jbHVkZXMoJ25vZGVfbW9kdWxlcycpXG4gICk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkKHBhdGg6IHN0cmluZykge1xuICByZXR1cm4gbmV3IENoYW5nZXMocGF0aCwgYXdhaXQgbG9hZFRpbWVzdGFtcHMocGF0aCkpO1xufVxuXG5leHBvcnQgY2xhc3MgQ2hhbmdlcyB7XG4gIHJlYWRvbmx5ICNwYXRoO1xuICByZWFkb25seSAjdGltZXN0YW1wczogVGltZXN0YW1wcztcbiAgI2xpbnRDYWNoZTtcblxuICBjb25zdHJ1Y3RvcihwYXRoOiBzdHJpbmcsIHRpbWVzdGFtcHM6IFRpbWVzdGFtcHMpIHtcbiAgICB0aGlzLiNwYXRoID0gcGF0aDtcbiAgICB0aGlzLiN0aW1lc3RhbXBzID0gdGltZXN0YW1wcztcbiAgICB0aGlzLiNsaW50Q2FjaGUgPSBtYWtlQ2FjaGUocGF0aCk7XG4gIH1cblxuICBhc3luYyBwcmVDb21waWxlKHJlcG9ydGVyOiBSZXBvcnRlciwgcGF0aDogc3RyaW5nKSB7XG4gICAgaWYgKGF3YWl0IHRoaXMuc2hvdWxkSW5zdGFsbCgpKSB7XG4gICAgICBhd2FpdCBpbnN0YWxsKHJlcG9ydGVyLCBwYXRoKTtcbiAgICAgIHRoaXMuI3RpbWVzdGFtcHMuc3RhZ2VzID0ge307XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcG9zdENvbXBpbGUoXG4gICAgcmVwb3J0ZXI6IFJlcG9ydGVyLFxuICAgIHBhdGg6IHN0cmluZyxcbiAgICBpbnB1dEZpbGVzOiBzdHJpbmdbXSxcbiAgICBjb21waWxlUmVzdWx0OiBQcm9taXNlPHN0cmluZ1tdIHwgdW5kZWZpbmVkPlxuICApIHtcbiAgICBjb25zdCBzb3VyY2UgPSBnZXRTb3VyY2UoaW5wdXRGaWxlcyk7XG4gICAgY29uc3QgcmVzdWx0ID0gKFxuICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICBjb21waWxlUmVzdWx0LFxuICAgICAgICB0aGlzLiNpZkNoYW5nZWQoJ2Zvcm1hdHRpbmcnLCBzb3VyY2UsIChzKSA9PlxuICAgICAgICAgIGZvcm1hdHRlZChyZXBvcnRlciwgcGF0aCwgcylcbiAgICAgICAgKSxcbiAgICAgICAgdGhpcy4jaWZDaGFuZ2VkKCdzcGVsbGluZycsIHNvdXJjZSwgKHMpID0+IHNwZWxsaW5nKHJlcG9ydGVyLCBwYXRoLCBzKSksXG4gICAgICAgIHRoaXMuI2lmQ2hhbmdlZCgnbGludGluZycsIHNvdXJjZSwgKHMpID0+XG4gICAgICAgICAgbGludChyZXBvcnRlciwgcGF0aCwgcywgdGhpcy4jbGludENhY2hlKVxuICAgICAgICApLFxuICAgICAgICB0aGlzLiNpZkNoYW5nZWQoJ3Rlc3RzJywgc291cmNlLCBhc3luYyAocykgPT4ge1xuICAgICAgICAgIGNvbnN0IG91dHB1dEZpbGVzID0gYXdhaXQgY29tcGlsZVJlc3VsdDtcbiAgICAgICAgICBpZiAoIW91dHB1dEZpbGVzKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IHRlc3RzID0gb3V0cHV0RmlsZXMuZmlsdGVyKFxuICAgICAgICAgICAgKGYpID0+IGRpcm5hbWUoZikgPT09ICd0ZXN0JyAmJiAhZi5lbmRzV2l0aCgnLmQudHMnKVxuICAgICAgICAgICk7XG4gICAgICAgICAgcmV0dXJuIGF3YWl0IHRlc3QocmVwb3J0ZXIsIHBhdGgsIHRlc3RzLCBzKTtcbiAgICAgICAgfSksXG4gICAgICBdKVxuICAgICkuZXZlcnkoKHIpID0+IHIpO1xuICAgIGF3YWl0IHRoaXMuI3NldE91dHB1dHMoYXdhaXQgY29tcGlsZVJlc3VsdCk7XG4gICAgYXdhaXQgdGhpcy4jc2F2ZVRpbWVzdGFtcHMoKTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgYXN5bmMgc2hvdWxkSW5zdGFsbCgpIHtcbiAgICBjb25zdCBvbGRlc3RTdGFnZSA9XG4gICAgICBPYmplY3QudmFsdWVzKHRoaXMuI3RpbWVzdGFtcHMuc3RhZ2VzKVxuICAgICAgICAubWFwKChkKSA9PiBuZXcgRGF0ZShkKS5nZXRUaW1lKCkpXG4gICAgICAgIC5zb3J0KClcbiAgICAgICAgLmF0KDApID8/IC0xO1xuICAgIGNvbnN0IGxhdGVzdFBhY2thZ2UgPVxuICAgICAgKFxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgICBbJ3BhY2thZ2UuanNvbicsICdwYWNrYWdlLWxvY2suanNvbiddLm1hcCgoZikgPT5cbiAgICAgICAgICAgIHN0YXQocmVzb2x2ZSh0aGlzLiNwYXRoLCBmKSlcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgIClcbiAgICAgICAgLm1hcCgocykgPT4gcy5jdGltZU1zKVxuICAgICAgICAuc29ydCgpXG4gICAgICAgIC5hdCgtMSkgPz8gMDtcbiAgICByZXR1cm4gb2xkZXN0U3RhZ2UgPCBsYXRlc3RQYWNrYWdlO1xuICB9XG5cbiAgYXN5bmMgc3RhZ2VDb21wbGV0ZShzdGFnZTogc3RyaW5nKSB7XG4gICAgdGhpcy4jdGltZXN0YW1wcy5zdGFnZXNbc3RhZ2VdID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgIGF3YWl0IHRoaXMuI3NhdmVUaW1lc3RhbXBzKCk7XG4gIH1cbiAgYXN5bmMgY2xlYXJTdGFnZXMoKSB7XG4gICAgdGhpcy4jdGltZXN0YW1wcy5zdGFnZXMgPSB7fTtcbiAgICB0aGlzLiNsaW50Q2FjaGUgPSBtYWtlQ2FjaGUodGhpcy4jcGF0aCk7XG4gICAgYXdhaXQgdGhpcy4jc2F2ZVRpbWVzdGFtcHMoKTtcbiAgfVxuXG4gIGFzeW5jICNpZkNoYW5nZWQoXG4gICAgc3RhZ2U6IHN0cmluZyxcbiAgICBzb3VyY2U6IHN0cmluZ1tdLFxuICAgIGZuOiAoc3JjOiBzdHJpbmdbXSkgPT4gUHJvbWlzZTxib29sZWFuPlxuICApIHtcbiAgICBjb25zdCB7IHN0YWdlcyB9ID0gdGhpcy4jdGltZXN0YW1wcztcbiAgICBpZiAoc3RhZ2VzW3N0YWdlXSkge1xuICAgICAgY29uc3QgbGFzdFN1Y2Nlc3MgPSBuZXcgRGF0ZShcbiAgICAgICAgdGhpcy4jdGltZXN0YW1wcy5zdGFnZXNbc3RhZ2VdID8/IDBcbiAgICAgICkuZ2V0VGltZSgpO1xuICAgICAgY29uc3Qgc3RhdHMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgc291cmNlLm1hcChhc3luYyAocykgPT4ge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgc3RhdChzKTtcbiAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBpZiAoaXNGaWxlTm90Rm91bmQoZSkpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHsgbXRpbWVNczogMCB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgICAgc291cmNlID0gc291cmNlXG4gICAgICAgIC5tYXAoKHMsIGl4KSA9PlxuICAgICAgICAgIChzdGF0c1tpeF0/Lm10aW1lTXMgPz8gTnVtYmVyLk1BWF9WQUxVRSkgPiBsYXN0U3VjY2VzcyA/IHMgOiAnJ1xuICAgICAgICApXG4gICAgICAgIC5maWx0ZXIoKHMpID0+ICEhcyk7XG4gICAgfVxuICAgIGlmIChhd2FpdCBmbihzb3VyY2UpKSB7XG4gICAgICBzdGFnZXNbc3RhZ2VdID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jICNzZXRPdXRwdXRzKG91dHB1dHM6IHN0cmluZ1tdIHwgdW5kZWZpbmVkKSB7XG4gICAgZm9yIChjb25zdCBvbGQgb2YgdGhpcy4jdGltZXN0YW1wcy5vdXRwdXRzKSB7XG4gICAgICBpZiAoIW91dHB1dHM/LmluY2x1ZGVzKG9sZCkpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBybShvbGQpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgaWYgKGlzRmlsZU5vdEZvdW5kKGUpKSB7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLiN0aW1lc3RhbXBzLm91dHB1dHMgPSBvdXRwdXRzID8/IFtdO1xuICB9XG5cbiAgYXN5bmMgI3NhdmVUaW1lc3RhbXBzKCkge1xuICAgIGF3YWl0IHdyaXRlRmlsZShcbiAgICAgIGpvaW4odGhpcy4jcGF0aCwgJy50aW1lc3RhbXBzLmpzb24nKSxcbiAgICAgIEpTT04uc3RyaW5naWZ5KHRoaXMuI3RpbWVzdGFtcHMsIHVuZGVmaW5lZCwgJyAgJylcbiAgICApO1xuICB9XG59XG5cbnR5cGUgVGltZXN0YW1wcyA9IHtcbiAgb3V0cHV0czogc3RyaW5nW107XG4gIHN0YWdlczogeyBbc3RhZ2U6IHN0cmluZ106IHN0cmluZyB9O1xufTtcblxuYXN5bmMgZnVuY3Rpb24gbG9hZFRpbWVzdGFtcHMocGF0aDogc3RyaW5nKSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIEpTT04ucGFyc2UoXG4gICAgICBhd2FpdCByZWFkRmlsZShqb2luKHBhdGgsICcudGltZXN0YW1wcy5qc29uJyksICd1dGYtOCcpXG4gICAgKSBhcyBUaW1lc3RhbXBzO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGlzRmlsZU5vdEZvdW5kKGUpKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBvdXRwdXRzOiBbXSxcbiAgICAgICAgc3RhZ2VzOiB7fSxcbiAgICAgIH07XG4gICAgfVxuICAgIHRocm93IGU7XG4gIH1cbn1cblxuZnVuY3Rpb24gaXNGaWxlTm90Rm91bmQoZTogdW5rbm93bikge1xuICByZXR1cm4gKGUgYXMgeyBjb2RlPzogc3RyaW5nIH0pLmNvZGUgPT09ICdFTk9FTlQnO1xufVxuIl19